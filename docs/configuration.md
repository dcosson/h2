# h2 Configuration

## Account Profiles

Each agent harness (Claude Code, Codex) has its own native configuration format. h2 manages these configs in per-profile directories under the h2 dir, so multiple agents can share auth credentials and base settings while keeping their configs isolated from the user's personal agent configs.

### Directory layout

```
~/.h2/
├── claude-config/
│   ├── default/          # default account profile
│   │   ├── .claude.json  # auth credentials (OAuth account)
│   │   └── settings.json # hooks, permissions allow/deny, etc.
│   └── work/             # named profile
│       ├── .claude.json
│       └── settings.json
├── codex-config/
│   ├── default/
│   │   ├── config.toml
│   │   └── requirements.toml  # prefix_rules, allowed policies, etc.
│   └── work/
│       └── ...
```

### What lives in account profiles

Tool allow/deny rules and command restrictions are configured in the native agent config format within the account profile, **not** in h2 role config:

| Setting | Claude Code | Codex |
|---|---|---|
| Auth credentials | `.claude.json` (OAuth) | `config.toml` (API key) |
| Tool allow/deny rules | `settings.json` → `permissions.allow` / `permissions.deny` | n/a |
| Command prefix rules | n/a | `requirements.toml` → `[rules].prefix_rules` |
| Hooks | `settings.json` → `hooks` (h2 injects standard hooks) | n/a (pending Codex hooks support) |

h2 sets the config directory for each agent via environment variables:
- Claude Code: `CLAUDE_CONFIG_DIR=<profile_dir>`
- Codex: `CODEX_HOME=<profile_dir>`

### Rationale

Each agent has unique rule formats (Claude Code uses glob-based tool patterns, Codex uses structured token-prefix patterns) that don't translate between harnesses. Rather than building a lossy abstraction layer, h2 delegates these to the native config files where users can use the full power of each agent's format.

## Instructions Hierarchy

Agents receive instructions from multiple sources, layered together. Understanding this hierarchy is important for deciding where to put different kinds of instructions.

### Claude Code

Claude Code loads instructions from these sources, in order:

1. **Global `~/.claude/CLAUDE.md`** — your personal Claude Code instructions (applies to all Claude Code usage, including outside h2)
2. **Account profile `CLAUDE.md`** — `~/.h2/claude-config/<profile>/CLAUDE.md`. h2 sets `CLAUDE_CONFIG_DIR` to the profile directory, so Claude Code reads this as its config-level `CLAUDE.md`.
3. **Role `system_prompt`** — if set, replaces Claude Code's entire default system prompt (`--system-prompt`). Use sparingly.
4. **Role `instructions`** — appended to Claude Code's default system prompt (`--append-system-prompt`). This is the most common place for role-specific instructions.
5. **Project `CLAUDE.md`** — `CLAUDE.md` in the agent's working directory (and parent directories). Claude Code discovers these automatically.

### Codex

Codex loads instructions from a similar hierarchy, with one notable difference:

1. **Global `~/.codex/AGENTS.md`** — **not loaded** by Codex when h2 sets `CODEX_HOME`. Since h2 overrides `CODEX_HOME` to the account profile directory, Codex does not read the user's personal `~/.codex/AGENTS.md`.
2. **Account profile `AGENTS.md`** — `~/.h2/codex-config/<profile>/AGENTS.md`. h2 sets `CODEX_HOME` to the profile directory.
3. **Role `instructions`** — passed via `-c instructions=<json>`.
4. **Project `AGENTS.md`** — `AGENTS.md` in the agent's working directory. Codex discovers this automatically.

### What goes where

**Account profile `CLAUDE.md` / `AGENTS.md`** — shared instructions that apply to all agents using that profile. This is a good place for:
- h2-specific instructions (generated by `h2 init`, e.g. how to use `h2 send`, `h2 list`)
- Shared tooling and methodology (coding conventions, testing strategy, design doc standards)
- Organization-wide guidance that all agents should follow

Keep the h2 instructions in the account profile as generated by `h2 init`. Add your own shared methodology and tooling instructions alongside them.

**Role `instructions`** — instructions specific to a particular role. This is the right place for:
- What the agent's job is and how to do it
- Role-specific constraints and priorities
- Task-specific context

**Role `system_prompt`** — replaces the agent's entire default system prompt. Use this when you need full control over the prompt (e.g., for highly specialized agents). You can also experiment with combining `system_prompt` and `instructions` — the system prompt sets the base, and instructions are appended to it.

**Project `CLAUDE.md` / `AGENTS.md`** — project-specific instructions that live in the repo's working directory. Useful for project conventions, build commands, and codebase-specific context. All agents working in that project directory pick these up automatically.

## Role Configuration

A **role** is a named YAML file in `~/.h2/roles/` that defines how to launch an agent: which harness, what model, approval settings, instructions, and runtime config.

### Role fields

| Field | Type | Default | Description |
|---|---|---|---|
| **Identity** | | | |
| `role_name` | string | *(required)* | Role identifier (referenced by `h2 run --role`) |
| `agent_name` | string | *(auto-generated)* | Agent name when launched; empty = random name. Supports templates and name functions (see below). Overridden by `h2 run --name`. |
| `description` | string | | Human-readable description |
| **Agent harness** | | | |
| `agent_harness` | string | `claude_code` | `claude_code` \| `codex` \| `generic` |
| `agent_harness_command` | string | harness default | Command override (e.g. custom binary path) |
| `agent_model` | string | | Model name; empty = agent app's own default |
| **Account profile** | | | |
| `agent_account_profile` | string | `default` | Account profile name (selects config subdirectory) |
| `claude_code_config_path` | string | `<h2>/claude-config/<profile>` | Explicit Claude config dir override |
| `claude_code_config_path_prefix` | string | `<h2>/claude-config` | Prefix for auto-derived Claude config path |
| `codex_config_path` | string | `<h2>/codex-config/<profile>` | Explicit Codex config dir override |
| `codex_config_path_prefix` | string | `<h2>/codex-config` | Prefix for auto-derived Codex config path |
| **Permissions / Approval** | | | |
| `permission_mode` | string | | Claude Code `--permission-mode`: `default` \| `acceptEdits` \| `plan` \| `dontAsk` \| `bypassPermissions` \| `delegate` |
| `codex_sandbox_mode` | string | | Codex `--sandbox`: `read-only` \| `workspace-write` \| `danger-full-access` |
| `codex_ask_for_approval` | string | | Codex `--ask-for-approval`: `untrusted` \| `on-request` \| `never` |
| `permission_review_agent` | object | | AI permission reviewer (see below) |
| **Prompt content** | | | |
| `system_prompt` | string | | Replaces agent's entire default system prompt (`--system-prompt`) |
| `instructions` | string | | Appended to default system prompt (`--append-system-prompt`) |
| **Runtime** | | | |
| `working_dir` | string | `.` | Agent working directory (absolute, relative to h2 dir, or `.` for invocation CWD) |
| `additional_dirs` | list | | Extra directories passed via `--add-dir` to Claude Code and Codex |
| `worktree` | object | | Git worktree settings (mutually exclusive with `working_dir`) |
| `heartbeat` | object | | Idle nudge configuration |
| `hooks` | yaml node | | Merged into Claude Code settings.json hooks |
| `settings` | yaml node | | Extra Claude Code settings.json keys |
| `variables` | map | | Template variable definitions for parameterized roles |

All fields are optional except `role_name`.

### Permission review agent

The `permission_review_agent` configures an AI reviewer that evaluates permission requests not handled by native allow/deny rules. Currently supported for Claude Code only.

```yaml
permission_review_agent:
  enabled: true    # defaults to true when instructions are set
  instructions: |
    You are reviewing permission requests for a coding agent.
    ALLOW: standard dev tools (read, write, edit, bash for builds/tests)
    DENY: destructive operations (rm -rf, sudo, force push)
    ASK_USER: anything unusual or security-sensitive
```

When enabled, h2 writes the instructions to `permission-reviewer.md` in the agent's session directory. The `h2 handle-hook` command reads this file and calls a fast model to evaluate each PermissionRequest.

### How settings are delivered to each agent

| Setting | Claude Code | Codex |
|---|---|---|
| Approval/permission mode | `--permission-mode <value>` | `--ask-for-approval <value>` |
| Sandbox | n/a | `--sandbox <value>` |
| Model | `--model <value>` | `--model <value>` |
| Instructions | `--append-system-prompt <value>` | `-c instructions=<json>` |
| System prompt | `--system-prompt <value>` | n/a |
| Additional dirs | `--add-dir <path>` (repeated) | `--add-dir <path>` (repeated) |
| Review agent | Written to session dir as `permission-reviewer.md` | Not yet supported |

### Examples

**Claude Code with auto-edit permissions:**

```yaml
role_name: coder
agent_harness: claude_code
agent_model: claude-sonnet-4-6
permission_mode: acceptEdits
instructions: |
  You are a coding agent. Implement features and write tests.
permission_review_agent:
  instructions: |
    ALLOW: standard dev tools
    DENY: destructive operations
```

**Codex with workspace sandbox:**

```yaml
role_name: codex-coder
agent_harness: codex
codex_sandbox_mode: workspace-write
codex_ask_for_approval: on-request
instructions: |
  You are a coding agent.
```

**Minimal role (Claude Code defaults):**

```yaml
role_name: helper
instructions: |
  You are a helpful assistant.
```

**Role with additional directories:**

```yaml
role_name: full-stack
agent_harness: claude_code
working_dir: ./frontend
additional_dirs:
  - ./backend
  - ./shared-libs
instructions: |
  You are a full-stack agent with access to frontend, backend, and shared libs.
```

**Role with a fixed agent name:**

```yaml
role_name: work-coder
agent_name: work-1
agent_account_profile: work
agent_harness: claude_code
permission_mode: acceptEdits
instructions: |
  You are a coding agent for the work account.
```

**Auto-incrementing agent names:**

```yaml
role_name: coder
agent_name: "{{ .RoleName }}-{{ autoIncrement .RoleName }}"
# Produces: coder-1, coder-2, coder-3...
instructions: |
  You are {{ .AgentName }}, a coding agent.
```

### Agent name resolution

The `agent_name` field supports Go template functions for generating unique agent names. Name resolution uses a **two-pass render**: the first pass resolves name functions, and the second pass makes the resolved `{{ .AgentName }}` available to all other fields (like `instructions`).

**Resolution order:**

1. CLI `--name` flag — used as-is, no template rendering
2. Role `agent_name` field — rendered as a template (pass 1), result becomes `{{ .AgentName }}` for pass 2
3. Fallback — random `adjective-noun` name (e.g. `calm-brook`) with collision detection

**Name functions:**

| Function | Signature | Description |
|---|---|---|
| `randomName` | `randomName()` → string | Random `adjective-noun` name with collision detection against running agents |
| `autoIncrement` | `autoIncrement(prefix)` → int | Scans running agents for `<prefix>-N`, returns `max(N)+1` |

Both functions are **cached between passes** — they return the same value in pass 1 and pass 2, so `randomName` won't generate a different name on the second render.

**Examples:**

```yaml
# Random name (equivalent to omitting agent_name)
agent_name: "{{ randomName }}"

# Fixed name
agent_name: my-agent

# Auto-increment with role name prefix: coder-1, coder-2, ...
agent_name: "{{ .RoleName }}-{{ autoIncrement .RoleName }}"

# Auto-increment with custom prefix: dev-1, dev-2, ...
agent_name: "dev-{{ autoIncrement \"dev\" }}"

# Conditional naming
{{ if eq .Var.env "prod" }}
agent_name: "prod-{{ autoIncrement \"prod\" }}"
{{ else }}
agent_name: "dev-{{ autoIncrement \"dev\" }}"
{{ end }}
```
